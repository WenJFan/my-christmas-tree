<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>3D 圣诞精雕互动系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.160.0/three.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,900;1,900&family=Dancing+Script:wght@700&display=swap');
        
        body { margin: 0; overflow: hidden; background: #000; color: white; font-family: ui-sans-serif, system-ui, sans-serif; touch-action: none; }
        canvas { display: block; width: 100vw; height: 100vh; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .font-cursive { font-family: 'Dancing Script', cursive; }
        
        .glass {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }

        /* 微信引导遮罩样式 */
        #wechat-guide {
            display: none; /* 默认隐藏 */
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 1000;
        }
        .guide-arrow {
            position: absolute; top: 20px; right: 20px;
            width: 60px; height: 60px;
            border-top: 4px solid #facc15; border-right: 4px solid #facc15;
            transform: rotate(-15deg);
            animation: arrow-jump 0.8s infinite alternate;
        }
        @keyframes arrow-jump {
            from { transform: translate(0, 0) rotate(-15deg); }
            to { transform: translate(-10px, 10px) rotate(-15deg); }
        }

        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 12s linear infinite; }
        
        @keyframes breathe {
            0%, 100% { opacity: 0.4; transform: scale(1); }
            50% { opacity: 0.9; transform: scale(1.1); }
        }
        .breathe-light { animation: breathe 3s ease-in-out infinite; }

        #video-container {
            width: 80px; height: 60px;
            overflow: hidden; border-radius: 0.75rem;
            transform: scaleX(-1);
            border: 1px solid rgba(255, 215, 0, 0.3);
            background: #1a1a2e;
        }
        @media (min-width: 768px) {
            #video-container { width: 160px; height: 120px; border-radius: 1rem; }
        }
        #video-container video { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body>

    <!-- 微信内部打开时的引导层 -->
    <div id="wechat-guide" class="flex flex-col items-center justify-center p-10 text-center">
        <div class="guide-arrow"></div>
        <div class="mt-20">
            <p class="text-yellow-400 text-2xl font-bold mb-4">为了完美的 3D 互动体验</p>
            <p class="text-white text-lg opacity-80">请点击右上角 <span class="text-yellow-400">“...”</span></p>
            <p class="text-white text-lg opacity-80 mt-2">选择 <span class="bg-white text-black px-2 py-1 rounded font-bold">在浏览器中打开</span></p>
        </div>
        <div class="mt-32 text-xs text-white/30 tracking-widest uppercase">
            Merry Christmas & Happy New Year
        </div>
    </div>

    <!-- UI 层 -->
    <div id="ui-layer" class="pointer-events-none absolute inset-0 z-50 flex flex-col justify-between p-4 md:p-10 pb-8 md:pb-12">
        
        <!-- 右上角控制 -->
        <div class="flex justify-end items-start">
            <div class="flex flex-col items-end gap-2 md:gap-4 pointer-events-auto">
                <div class="glass p-1.5 md:p-2 rounded-[1rem] relative">
                    <div id="video-container">
                        <video id="webcam" autoplay playsinline></video>
                    </div>
                    <div class="absolute inset-0 flex items-center justify-center pointer-events-none" id="cam-placeholder">
                        <span class="text-[6px] md:text-[8px] text-yellow-200/40 font-bold uppercase text-center">Vision Off</span>
                    </div>
                </div>
                <button id="cam-btn" class="px-3 py-1.5 md:px-6 md:py-3 glass rounded-lg md:rounded-2xl text-yellow-100 text-[7px] md:text-[10px] font-black hover:bg-white/20 transition-all uppercase tracking-tighter md:tracking-widest">
                    开启交互
                </button>
                <div class="flex gap-2">
                    <button onclick="window.changePhase('blooming')" class="px-2 py-1.5 md:px-4 md:py-2 glass rounded-lg text-[8px] md:text-[10px] text-yellow-400 font-bold active:scale-95">✋ 绽放</button>
                    <button onclick="window.changePhase('collapsing')" class="px-2 py-1.5 md:px-4 md:py-2 glass rounded-lg text-[8px] md:text-[10px] text-red-400 font-bold active:scale-95">✊ 重置</button>
                </div>
            </div>
        </div>

        <!-- 中央标题 -->
        <div id="title-container" class="text-center py-6 md:py-16 pb-24 md:pb-40 px-4">
            <h1 id="hero-title" class="text-4xl sm:text-6xl md:text-7xl lg:text-[9rem] font-cursive text-transparent bg-clip-text bg-gradient-to-b from-white via-yellow-100 to-yellow-500 drop-shadow-[0_10px_30px_rgba(234,179,8,0.4)] select-none leading-[1.5] transition-opacity duration-500">
                Merry Christmas
            </h1>
        </div>

        <!-- 底部音乐栏 -->
        <div class="flex justify-center items-center">
            <div class="glass px-5 py-2.5 md:px-10 md:py-5 rounded-full flex items-center gap-3 md:gap-8 pointer-events-auto max-w-full">
                <div class="relative w-6 h-6 md:w-12 md:h-12 flex items-center justify-center flex-shrink-0">
                    <div class="absolute inset-0 bg-yellow-400/20 rounded-full breathe-light"></div>
                    <div class="text-yellow-200/40 text-sm md:text-3xl animate-spin-slow select-none">❄️</div>
                </div>
                <div class="flex flex-col min-w-0 max-w-[120px] md:max-w-none">
                    <span class="text-[6px] md:text-[8px] text-yellow-200/30 uppercase tracking-[0.2em] md:tracking-[0.4em] font-black">Now Playing</span>
                    <span class="text-white/90 text-[8px] md:text-xs font-bold tracking-wide truncate">Last Christmas - Taylor Swift</span>
                </div>
                <div id="visualizer" class="flex gap-1 h-4 md:h-6 items-end pb-0.5 flex-shrink-0"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import {
            HandLandmarker,
            FilesetResolver
        } from "https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3";

        /** --- 1. 全局变量与状态 --- **/
        let scene, camera, renderer, particles, treeLights, star, propsGroup;
        let photoGroup = new THREE.Group(); 
        let phase = 'tree'; 
        let globalBeat = 0.5; 
        let isMobile = window.innerWidth < 768;
        let webcamRunning = false;
        let audioCtx, bgMusic, handLandmarker, videoElement;

        const particleCount = isMobile ? 6000 : 9000;
        const lightStringCount = isMobile ? 800 : 1200;
        const myImages = [
            "https://i1.hdslb.com/bfs/new_dyn/075b0a90eca974408bf5b118b44b3caf286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/new_dyn/a9081380f6c38cfc7105ceed0c0dc262286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/new_dyn/adcf3d7c7fe42db597c2c29bbdf5e608286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/new_dyn/d29ea8d66c33bb4ff49fb39d99c6658a286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/new_dyn/9aa511bcd1e52f29465b742fc52cbc75286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/new_dyn/62629249d7da5cc5b69b2ad9bdc031aa286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/fb13ac82b4ec45bc249b98fd442a3f0b286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/b3f486c92b2a6c853c79b1c0f1cbf5d4286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/9fa5f592bde7766a62d20231dcc840d3286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/3adcc2eec76dbaf263c0e3c3c6ba36c1286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/9d7b41d0bb2582689ca1f0b56115fd7b286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/678ae8b0c1dd34971047f925b04b828c286431045.jpg@1192w.avif",
            "https://i1.hdslb.com/bfs/article/7f5643d89e17543ee9f5eb2c3e0c8e32286431045.jpg@1192w.avif"
        ];
        const photoCount = myImages.length;
        const bgMusicUrl = "https://raw.githubusercontent.com/Eric-dot/-christmas-trees-/main/Last%20Christmas.mp3"; 
        const customBgUrl = "https://images.pexels.com/photos/1175136/pexels-photo-1175136.jpeg";

        const fireworks = [];
        const fwGroup = new THREE.Group();
        const positions = { tree: [], rotations: [], scaleFactors: [], lightsTree: [], nebula: [], lightsNebula: [] };
        const dummy = new THREE.Object3D();

        /** --- 微信浏览器环境检测 (核心改进) --- **/
        function checkWechat() {
            const ua = navigator.userAgent.toLowerCase();
            const guide = document.getElementById('wechat-guide');
            if (ua.match(/MicroMessenger/i) == "micromessenger") {
                guide.style.display = 'block';
                return true;
            }
            guide.style.display = 'none';
            return false;
        }

        /** --- 2. 核心类与辅助函数 --- **/
        
        class RealFirework {
            constructor() {
                this.done = false; this.exploded = false; this.particles = [];
                this.pos = new THREE.Vector3((Math.random()-0.5)*400, -120, (Math.random()-0.5)*250);
                this.vel = new THREE.Vector3((Math.random()-0.5)*2.5, 3.5 + Math.random()*2, (Math.random()-0.5)*1.5);
                this.rocket = new THREE.Mesh(new THREE.SphereGeometry(0.7, 4, 4), new THREE.MeshBasicMaterial({ color: 0xffffff }));
                fwGroup.add(this.rocket);
            }
            update() {
                if (!this.exploded) {
                    this.pos.add(this.vel); this.vel.y -= 0.04; this.rocket.position.copy(this.pos);
                    if (this.vel.y <= 0.15) this.explode();
                } else {
                    this.particles.forEach(p => {
                        p.pos.add(p.vel); p.vel.multiplyScalar(0.98); p.life -= 0.01; 
                        p.mesh.position.copy(p.pos); p.mesh.scale.setScalar(Math.max(0, p.life * 2));
                        if (p.mesh.material) p.mesh.material.opacity = p.life;
                    });
                    if (this.particles.every(p => p.life <= 0)) { this.done = true; this.cleanup(); }
                }
            }
            explode() {
                this.exploded = true; fwGroup.remove(this.rocket); playBoomSound();
                const count = 100; const color = new THREE.Color().setHSL(Math.random(), 1, 0.6);
                for (let i = 0; i < count; i++) {
                    const pMesh = new THREE.Mesh(new THREE.SphereGeometry(0.3, 4, 4), new THREE.MeshBasicMaterial({ color, transparent: true, blending: THREE.AdditiveBlending }));
                    const v = new THREE.Vector3(Math.random()-0.5, Math.random()-0.5, Math.random()-0.5).normalize().multiplyScalar(Math.random()*4.5);
                    this.particles.push({ mesh: pMesh, pos: this.pos.clone(), vel: v, life: 1.0 });
                    fwGroup.add(pMesh);
                }
            }
            cleanup() { this.particles.forEach(p => fwGroup.remove(p.mesh)); }
        }

        function createCandyStripeTexture() {
            const canvas = document.createElement('canvas');
            canvas.width = 128; canvas.height = 128;
            const ctx = canvas.getContext('2d');
            ctx.fillStyle = "#ffffff"; ctx.fillRect(0, 0, 128, 128);
            ctx.fillStyle = "#d32f2f"; 
            ctx.beginPath(); ctx.moveTo(0, 0); ctx.lineTo(64, 0); ctx.lineTo(128, 64); ctx.lineTo(128, 128); ctx.closePath(); ctx.fill();
            ctx.beginPath(); ctx.moveTo(0, 64); ctx.lineTo(64, 128); ctx.lineTo(0, 128); ctx.closePath(); ctx.fill();
            const tex = new THREE.CanvasTexture(canvas);
            tex.wrapS = tex.wrapT = THREE.RepeatWrapping;
            tex.repeat.set(4, 1);
            return tex;
        }

        function createFivePointStar(outerRadius, innerRadius, depth) {
            const shape = new THREE.Shape();
            for (let i = 0; i < 10; i++) {
                const r = i % 2 === 0 ? outerRadius : innerRadius;
                const a = (i * Math.PI) / 5 + (Math.PI / 2);
                const x = Math.cos(a) * r, y = Math.sin(a) * r;
                if (i === 0) shape.moveTo(x, y); else shape.lineTo(x, y);
            }
            return new THREE.ExtrudeGeometry(shape, { depth, bevelEnabled: true, bevelThickness: 0.02, bevelSize: 0.02 });
        }

        function createDetailedProp(type, color) {
            const group = new THREE.Group();
            if (type === 'GIFT') {
                const boxMat = new THREE.MeshStandardMaterial({ color: 0xd32f2f, metalness: 0.2, roughness: 0.4, emissive: 0xd32f2f, emissiveIntensity: 0.1 });
                group.add(new THREE.Mesh(new THREE.BoxGeometry(0.5, 0.5, 0.5), boxMat));
                const ribMat = new THREE.MeshStandardMaterial({ color: 0xffd700, metalness: 0.8, roughness: 0.1, emissive: 0xffd700, emissiveIntensity: 0.1 });
                group.add(new THREE.Mesh(new THREE.BoxGeometry(0.12, 0.52, 0.52), ribMat));
                group.add(new THREE.Mesh(new THREE.BoxGeometry(0.52, 0.52, 0.12), ribMat));
                const bowGeo = new THREE.TorusGeometry(0.1, 0.03, 8, 16);
                const bow1 = new THREE.Mesh(bowGeo, ribMat);
                const bow2 = new THREE.Mesh(bowGeo, ribMat);
                bow1.position.set(0.08, 0.3, 0); bow1.rotation.y = Math.PI/4;
                bow2.position.set(-0.08, 0.3, 0); bow2.rotation.y = -Math.PI/4;
                group.add(bow1, bow2);
            } else if (type === 'BELL') {
                const bellMat = new THREE.MeshStandardMaterial({ color: 0xffe066, metalness: 0.9, roughness: 0.1, emissive: 0xffaa00, emissiveIntensity: 0.2 });
                const pts = [new THREE.Vector2(0, 0.45), new THREE.Vector2(0.1, 0.43), new THREE.Vector2(0.2, 0.35), new THREE.Vector2(0.25, 0.05), new THREE.Vector2(0.28, 0)];
                group.add(new THREE.Mesh(new THREE.LatheGeometry(pts, 24), bellMat));
                const tongue = new THREE.Mesh(new THREE.SphereGeometry(0.05, 8, 8), bellMat);
                tongue.position.y = 0.1; group.add(tongue);
            } else if (type === 'CANDY') {
                const pts = []; for (let i = 0; i <= 20; i++) {
                    const t = i / 20;
                    if (t < 0.7) pts.push(new THREE.Vector3(0, 0.4 - t*1.2, 0));
                    else {
                        const angle = (t - 0.7) / 0.3 * Math.PI;
                        pts.push(new THREE.Vector3(Math.sin(angle)*0.2, -0.44 - Math.cos(angle)*0.2, 0));
                    }
                }
                const candyMat = new THREE.MeshStandardMaterial({ map: createCandyStripeTexture(), roughness: 0.2, metalness: 0.1 });
                group.add(new THREE.Mesh(new THREE.TubeGeometry(new THREE.CatmullRomCurve3(pts), 40, 0.07, 12, false), candyMat));
            } else if (type === 'BAUBLE') {
                group.add(new THREE.Mesh(new THREE.SphereGeometry(0.22, 16, 16), new THREE.MeshStandardMaterial({ color: color, metalness: 0.9, emissive: color, emissiveIntensity: 0.2 })));
            }
            return group;
        }

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            if (!bgMusic) {
                bgMusic = new Audio(bgMusicUrl);
                bgMusic.loop = true; bgMusic.volume = 0.5;
            }
            bgMusic.play().catch(() => {});
        }

        function playBoomSound() {
            if (!audioCtx) return;
            const duration = 1.8;
            const buffer = audioCtx.createBuffer(1, audioCtx.sampleRate * duration, audioCtx.sampleRate);
            const data = buffer.getChannelData(0);
            for (let i = 0; i < data.length; i++) data[i] = (Math.random() * 2 - 1) * Math.exp(-i / (audioCtx.sampleRate * 0.1));
            const source = audioCtx.createBufferSource(); source.buffer = buffer;
            const lowPass = audioCtx.createBiquadFilter(); lowPass.type = 'lowpass'; lowPass.frequency.value = 100;
            const gain = audioCtx.createGain(); gain.gain.setValueAtTime(0.8, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);
            source.connect(lowPass); lowPass.connect(gain); gain.connect(audioCtx.destination);
            source.start();
        }

        /** --- 3. 适配与场景渲染 --- **/
        function updateBackgroundFit() {
            if (!scene || !scene.background || !scene.background.image) return;
            const img = scene.background.image;
            const sA = window.innerWidth / window.innerHeight, iA = img.width / img.height;
            if (sA > iA) { scene.background.repeat.set(1, iA/sA); scene.background.offset.set(0, (1-iA/sA)/2); }
            else { scene.background.repeat.set(sA/iA, 1); scene.background.offset.set((1-sA/iA)/2, 0); }
            const scale = 0.87; scene.background.repeat.multiplyScalar(scale);
            scene.background.offset.x += (1-scale)*scene.background.repeat.x/2;
            scene.background.offset.y += (1-scale)*scene.background.repeat.y/2;
        }

        function updateCameraPosition() {
            if (!camera) return;
            isMobile = window.innerWidth < 768;
            const aspect = window.innerWidth / window.innerHeight;
            if (aspect < 1) { camera.position.set(0, 5, 75); camera.fov = 65; }
            else { camera.position.set(0, 5, 50); camera.fov = 55; }
            camera.updateProjectionMatrix();
        }

        function onResize() {
            if (camera) { camera.aspect = window.innerWidth / window.innerHeight; updateCameraPosition(); }
            if (renderer) renderer.setSize(window.innerWidth, window.innerHeight);
            updateBackgroundFit();
        }

        async function initHandLandmarker() {
            try {
                const vision = await FilesetResolver.forVisionTasks("https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@0.10.3/wasm");
                handLandmarker = await HandLandmarker.createFromOptions(vision, {
                    baseOptions: { modelAssetPath: `https://storage.googleapis.com/mediapipe-models/hand_landmarker/hand_landmarker/float16/1/hand_landmarker.task`, delegate: "GPU" },
                    runningMode: "VIDEO", numHands: 1
                });
            } catch (e) { console.error("MediaPipe Init Error"); }
        }

        function initScene() {
            scene = new THREE.Scene();
            const tL = new THREE.TextureLoader();
            tL.load(customBgUrl, (t) => {
                t.anisotropy = renderer.capabilities.getMaxAnisotropy();
                t.wrapS = t.wrapT = THREE.ClampToEdgeWrapping;
                scene.background = t; scene.environment = t; updateBackgroundFit();
            });

            camera = new THREE.PerspectiveCamera(55, window.innerWidth / window.innerHeight, 1, 8000);
            updateCameraPosition();
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true, powerPreference: "high-performance" });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
            document.body.appendChild(renderer.domElement);

            scene.add(fwGroup); scene.add(new THREE.AmbientLight(0xffffff, 1.3));
            const wL = new THREE.PointLight(0xffeebb, 200); wL.position.set(15, 15, 15); scene.add(wL);
            
            star = new THREE.Mesh(createFivePointStar(1.2, 0.5, 0.2), new THREE.MeshStandardMaterial({ color: 0xFFD700, emissive: 0xFFD700, emissiveIntensity: 10 }));
            star.position.y = 14.5; scene.add(star);

            particles = new THREE.InstancedMesh(new THREE.ConeGeometry(0.2, 0.65, 3), new THREE.MeshStandardMaterial({ color: 0x052b05, transparent: true, opacity: 1.0 }), particleCount);
            treeLights = new THREE.InstancedMesh(new THREE.SphereGeometry(0.08, 8, 8), new THREE.MeshStandardMaterial({ color: 0xffffff, emissive: 0xffffff, emissiveIntensity: 20, transparent: true }), lightStringCount);
            scene.add(particles, treeLights);

            for (let i = 0; i < particleCount; i++) {
                const p = i/particleCount, y = p * 24 - 10 + (Math.random()-0.5)*0.6;
                const rad = (1-p) * 10.5 * (1 + Math.sin(p*60)*0.15) + (Math.random()-0.5)*1.5;
                const ang = i * 0.12 + (Math.random()-0.5)*0.8;
                positions.tree.push(new THREE.Vector3(Math.cos(ang)*rad, y, Math.sin(ang)*rad));
                positions.scaleFactors.push(0.7 + Math.random()*0.7);
                const dR = new THREE.Object3D(); dR.position.copy(positions.tree[i]); dR.lookAt(positions.tree[i].x*2, y-5, positions.tree[i].z*2);
                positions.rotations.push(dR.quaternion.clone());
                positions.nebula.push(new THREE.Vector3(Math.cos(i*0.2)*35, (Math.random()-0.5)*30, Math.sin(i*0.2)*35));
            }

            const rings = 10;
            for (let i = 0; i < lightStringCount; i++) {
                const p = i/lightStringCount, rIdx = Math.floor(p * rings);
                const py = (rIdx/rings) * 23.5 - 10, radius = (1 - (rIdx/rings)) * 10.8;
                const ang = (i % (lightStringCount/rings)) * (Math.PI * 2 / (lightStringCount/rings));
                positions.lightsTree.push(new THREE.Vector3(Math.cos(ang)*radius, py, Math.sin(ang)*radius));
                positions.lightsNebula.push(new THREE.Vector3(Math.cos(i)*40, (Math.random()-0.5)*40, Math.sin(i)*40));
            }

            propsGroup = new THREE.Group();
            const gc = [0xd32f2f, 0x388e3c, 0x1976d2, 0xfbc02d]; 
            const baublePalette = [0xff007f, 0x7f00ff, 0x00ffff, 0xffa500, 0x00ff00, 0x0000ff, 0xffff00];

            for (let i = 0; i < 160; i++) {
                const type = ['BAUBLE', 'BELL', 'CANDY', 'GIFT'][i % 4];
                let pColor = (type === 'BAUBLE') ? baublePalette[i % baublePalette.length] : gc[i % gc.length];
                const prop = createDetailedProp(type, pColor);
                const p = i/160, rad = (1-p)*11.5 + (Math.random()-0.5), ang = i * 1.37;
                prop.position.set(Math.cos(ang)*rad, p*23-10, Math.sin(ang)*rad);
                prop.userData = { 
                    origin: prop.position.clone(), 
                    nebulaTarget: new THREE.Vector3(Math.cos(Math.random()*6)*25, (Math.random()-0.5)*20, Math.sin(Math.random()*6)*25),
                    floatSpeed: 0.5 + Math.random() * 0.5
                };
                propsGroup.add(prop);
            }
            scene.add(propsGroup);

            photoGroup.visible = false;
            for (let i = 0; i < photoCount; i++) {
                const angle = (i / photoCount) * Math.PI * 2, ringRadius = isMobile ? 40 : 50, frame = new THREE.Group();
                const inner = new THREE.Mesh(new THREE.PlaneGeometry(isMobile ? 18 : 28, isMobile ? 11 : 17), new THREE.MeshBasicMaterial({ transparent: true, opacity: 1.0 }));
                tL.load(myImages[i], (t) => { inner.material.map = t; if(t.image && t.image.width < t.image.height) inner.scale.set(0.6, 0.6, 1); inner.material.needsUpdate = true; });
                frame.add(inner); frame.position.set(Math.cos(angle)*ringRadius, 0, Math.sin(angle)*ringRadius);
                frame.lookAt(0, 0, 0); frame.userData = { originalAngle: angle }; photoGroup.add(frame);
            }
            scene.add(photoGroup);

            window.addEventListener('resize', onResize);
            window.addEventListener('click', initAudio, { once: true });
            window.addEventListener('touchstart', initAudio, { once: true });
        }

        /** --- 4. 动画循环 --- **/
        function animate() {
            requestAnimationFrame(animate);
            if (!renderer || !scene || !camera) return;
            const time = performance.now() * 0.001; globalBeat = 0.5 + Math.sin(time*4)*0.3; 
            
            if (Math.random() < 0.015) fireworks.push(new RealFirework());
            for (let i = fireworks.length-1; i>=0; i--) { fireworks[i].update(); if(fireworks[i].done) fireworks.splice(i,1); }

            if (handLandmarker && webcamRunning && videoElement) {
                const res = handLandmarker.detectForVideo(videoElement, performance.now());
                if (res.landmarks && res.landmarks[0]) {
                    const hand = res.landmarks[0], ext = [8, 12, 16, 20].filter(j => hand[j].y < hand[j - 2].y).length;
                    if (ext >= 3 && phase === 'tree') window.changePhase('blooming');
                    else if (ext <= 1 && phase === 'nebula') window.changePhase('collapsing');
                    if (phase === 'nebula' && photoGroup) photoGroup.rotation.y += (hand[9].x - 0.5) * 0.05;
                }
            }

            if (phase === 'nebula' && photoGroup && photoGroup.children.length > 0) {
                photoGroup.rotation.y += 0.003;
                photoGroup.children.forEach(c => {
                    if (!c || !c.userData || !c.children[0]) return;
                    const ang = (c.userData.originalAngle + photoGroup.rotation.y) % (Math.PI*2);
                    let diff = ang; if (diff > Math.PI) diff -= Math.PI*2; if (diff < -Math.PI) diff += Math.PI*2;
                    const isViewable = Math.abs(diff) < 1.8; 
                    c.visible = isViewable;
                    if (c.children[0].material) c.children[0].material.opacity = 1.0;
                    c.scale.setScalar(isViewable ? 1.0 : 0.5);
                });
            }

            if (propsGroup) {
                if (phase === 'tree' || phase === 'collapsing') {
                    propsGroup.rotation.y += 0.005;
                    propsGroup.children.forEach((p, i) => {
                        p.rotation.z = Math.sin(time * 2 + i) * 0.1;
                        p.position.y += Math.sin(time * 1.5 + i) * 0.002;
                    });
                } else {
                    propsGroup.children.forEach((p, i) => {
                        const data = p.userData, dist = Math.sqrt(data.nebulaTarget.x**2 + data.nebulaTarget.z**2);
                        const curAng = Math.atan2(data.nebulaTarget.z, data.nebulaTarget.x) + time * 0.2;
                        p.position.set(Math.cos(curAng) * dist, data.nebulaTarget.y + Math.sin(time * data.floatSpeed + i) * 3, Math.sin(curAng) * dist);
                        p.rotation.x += 0.01; p.rotation.y += 0.01;
                    });
                }
            }

            [particles, treeLights].forEach((m, idx) => {
                if(!m || !m.instanceMatrix) return;
                for (let i = 0; i < m.count; i++) {
                    let target;
                    if (phase === 'tree' || phase === 'collapsing') target = (idx === 0) ? positions.tree[i] : positions.lightsTree[i];
                    else {
                        const base = (idx === 0) ? positions.nebula[i] : positions.lightsNebula[i];
                        const dist = Math.sqrt(base.x**2 + base.z**2), curAng = Math.atan2(base.z, base.x) + time * 0.15;
                        target = new THREE.Vector3(Math.cos(curAng) * dist, base.y + Math.sin(time + i * 0.1) * 2, Math.sin(curAng) * dist);
                    }
                    if(!target) continue;
                    m.getMatrixAt(i, dummy.matrix); dummy.matrix.decompose(dummy.position, dummy.quaternion, dummy.scale);
                    dummy.position.lerp(target, 0.08);
                    if (idx === 0 && positions.rotations[i]) dummy.quaternion.slerp(positions.rotations[i], 0.08);
                    const sBase = idx === 0 ? 1.25 * (positions.scaleFactors[i]||1) : (Math.sin(time*8+i)*0.3+1)*1.2;
                    dummy.scale.setScalar((phase === 'tree' ? sBase : sBase*0.5) * (0.8 + globalBeat * 0.4));
                    dummy.updateMatrix(); m.setMatrixAt(i, dummy.matrix);
                }
                m.instanceMatrix.needsUpdate = true;
            });
            renderer.render(scene, camera);
        }

        /** --- 6. 相位管理 --- **/
        window.changePhase = function(newPhase) {
            if (phase === newPhase) return;
            phase = newPhase;
            const titleEl = document.getElementById('hero-title');
            if (phase === 'blooming') {
                gsap.to(titleEl, { opacity: 0, duration: 0.4, onComplete: () => {
                    titleEl.innerText = "Wishing you a joyful Christmas!";
                    gsap.to(titleEl, { opacity: 1, duration: 0.6 });
                }});
                if(star) gsap.to(star.scale, { x: 0, y: 0, z: 0, duration: 1 });
                if(particles.material) gsap.to(particles.material, { opacity: 0.2, duration: 1.5 });
                if(treeLights.material) gsap.to(treeLights.material, { opacity: 0.2, duration: 1.5 });
                propsGroup.children.forEach(o => gsap.to(o.position, { x: o.userData.nebulaTarget.x, y: o.userData.nebulaTarget.y, z: o.userData.nebulaTarget.z, duration: 2 }));
                setTimeout(() => { if(photoGroup) { photoGroup.visible = true; photoGroup.scale.set(0,0,0); gsap.to(photoGroup.scale, { x: 1, y: 1, z: 1, duration: 1.0, ease: "back.out(1.7)" }); } changePhase('nebula'); }, 1500);
            } else if (phase === 'collapsing') {
                gsap.to(titleEl, { opacity: 0, duration: 0.4, onComplete: () => {
                    titleEl.innerText = "Merry Christmas";
                    gsap.to(titleEl, { opacity: 1, duration: 0.6 });
                }});
                if(photoGroup) gsap.to(photoGroup.scale, { x: 0, y: 0, z: 0, duration: 1, onComplete: () => photoGroup.visible = false });
                if(star) gsap.to(star.scale, { x: 1, y: 1, z: 1, duration: 1, delay: 0.5 });
                if(particles.material) gsap.to(particles.material, { opacity: 1.0, duration: 1.5 });
                if(treeLights.material) gsap.to(treeLights.material, { opacity: 1.0, duration: 1.5 });
                propsGroup.children.forEach(o => gsap.to(o.position, { x: o.userData.origin.x, y: o.userData.origin.y, z: o.userData.origin.z, duration: 2 }));
                setTimeout(() => phase = 'tree', 2000);
            }
        }

        async function startApp() {
            checkWechat(); // 启动检测
            initScene(); await initHandLandmarker();
            const btn = document.getElementById("cam-btn"), ph = document.getElementById("cam-placeholder");
            videoElement = document.getElementById("webcam");
            btn.addEventListener("click", async () => {
                initAudio();
                if (!webcamRunning) {
                    try {
                        const s = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                        videoElement.srcObject = s;
                        videoElement.onloadedmetadata = () => { webcamRunning = true; ph.style.display = "none"; btn.innerText = "交互在线"; };
                    } catch (e) { console.warn("Camera access denied"); }
                } else {
                    webcamRunning = false; btn.innerText = "开启交互"; ph.style.display = "flex";
                    if(videoElement.srcObject) videoElement.srcObject.getTracks().forEach(t => t.stop());
                }
            });
            initAudio();
            const cont = document.getElementById('visualizer');
            if(cont) {
                for(let i=0; i<12; i++) { const b = document.createElement('div'); b.className = 'w-0.5 md:w-1 bg-white/40 rounded-full transition-all duration-100'; cont.appendChild(b); }
                setInterval(() => { if(cont) [...cont.children].forEach(b => b.style.height = (Math.random()*100)+'%'); }, 100);
            }
            animate();
        }
        startApp();
    </script>
</body>
</html>
